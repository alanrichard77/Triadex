<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Triadex</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .row{display:flex;gap:10px}
    #msg{margin-top:8px;color:#9db0cf;font-size:12px}
    .t { width:100%; border-collapse: collapse; }
    .t th, .t td { border-bottom:1px solid var(--border); padding:10px; text-align:right; }
    .t th:first-child, .t td:first-child { text-align:left; }
    .up{color:#3ad07a}.down{color:#ff5c5c}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Triadex</h1>
      <p class="subtitle">Cotações e fechamento do último pregão quando indisponível intraday</p>
    </header>

    <section class="card">
      <div class="row">
        <input id="q" type="text" placeholder="Ticker (ex: PETR4, VALE3, IVVB11, AAPL)" />
        <button id="btn">Buscar</button>
      </div>
      <div id="msg"></div>
      <pre id="out" style="white-space:pre-wrap;background:#0f1624;padding:12px;border-radius:10px;margin-top:8px"></pre>
    </section>

    <section class="card">
      <div class="list-controls row">
        <select id="listSel"></select>
        <button id="listBtn">Carregar lista</button>
      </div>
      <div class="table-wrap">
        <table class="t">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Preço</th>
              <th>Var %</th>
              <th>Volume</th>
              <th>Market Cap</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </section>

    <footer>
      <span>Dados de mercado atualizados automaticamente</span>
      <span class="brand">@alan_richard</span>
    </footer>
  </div>

  <script>
    let ctrl;
    const elQ = document.getElementById('q');
    const elBtn = document.getElementById('btn');
    const elMsg = document.getElementById('msg');
    const elOut = document.getElementById('out');
    const listSel = document.getElementById('listSel');
    const listBtn = document.getElementById('listBtn');
    const listBody = document.getElementById('listBody');

    function setBusy(b){ elBtn.disabled=b; elBtn.textContent=b?'Buscando...':'Buscar'; }
    function toast(t){ elMsg.textContent=t||''; }

    async function fetchQuote() {
      const q = elQ.value.trim(); if (!q) return;
      if (ctrl) ctrl.abort(); ctrl = new AbortController();
      setBusy(true); toast('');
      try {
        const res = await fetch(`/api/quote?q=${encodeURIComponent(q)}`, {signal: ctrl.signal});
        const txt = await res.text();
        elOut.textContent = txt;
        if (!res.ok) toast('Não consegui obter agora — tente novamente.');
      } catch {
        toast('Conexão interrompida.');
      } finally { setBusy(false); }
    }

    async function loadLists() {
      const r = await fetch('/api/lists');
      const arr = await r.json();
      listSel.innerHTML = '';
      for (const it of arr) {
        const o = document.createElement('option');
        o.value = it.key; o.textContent = it.label; listSel.appendChild(o);
      }
    }

    async function loadList() {
      const key = listSel.value;
      const r = await fetch(`/api/watchlist?list=${encodeURIComponent(key)}`);
      const data = await r.json();
      listBody.innerHTML = '';
      for (const row of data.items) {
        const tr = document.createElement('tr');
        const pct = row.price.change_pct;
        tr.innerHTML = `
          <td>${row.resolved.symbol}</td>
          <td class="td-r">${row.price.last ?? '—'} ${row.price.currency || ''}</td>
          <td class="td-r ${pct==null?'':(pct>=0?'up':'down')}">${pct==null?'—':(pct>0?'+':'')+pct.toFixed(2)+'%'}</td>
          <td class="td-r">${row.volume.value ?? '—'}</td>
          <td class="td-r">${row.market_cap.value ?? '—'} ${row.market_cap.currency || ''}</td>
        `;
        listBody.appendChild(tr);
      }
    }

    elBtn.addEventListener('click', fetchQuote);
    elQ.addEventListener('keydown', e => { if (e.key === 'Enter') fetchQuote(); });
    listBtn.addEventListener('click', loadList);
    loadLists();
  </script>
</body>
</html>
